<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Typer (read-dwarf.Trace__.Typer)</title><link rel="stylesheet" href="../../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 1.5.1"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="content"><header><nav><a href="../index.html">Up</a> – <a href="../../index.html">read-dwarf</a> &#x00BB; <a href="../index.html">Trace__</a> &#x00BB; Typer</nav><h1>Module <code>Trace__.Typer</code></h1><nav class="toc"><ul><li><a href="#exp">Expressions</a></li><li><a href="#read">Memory Read</a></li><li><a href="#write">Memory Write</a></li></ul></nav></header><aside><p>This module provide most of the C type inference logic</p><p>An important remark about this logic is that all types are optional. The absence of types is like a poison that propagates to the end, meaning that if any value in expression does not have a C type, then the whole expression won't have one. This behavior may need to be thought of again.</p><p>The second important remark is that we don't really care about the typing of non-pointer values. Whether an plain integer is an <code>int</code> or a <code>long</code> is completely irrelevant to us. On the other hand, whether a pointer is a <code>int*</code> or a <code>long*</code> is very important. That's why more non-pointer types will decay to <a href="../../Ctype/index.html#type-unqualified.Machine"><code>Ctype.unqualified.Machine</code></a> in all rules.</p><p>The type inference is decomposed in two parts:</p><ul><li>First, we have to type <a href="index.html#exp"><span>expressions</span></a> themselves as if they were expressions on C values and not machine values.</li><li>Second, we have to type effects like <a href="index.html#read"><span>reading</span></a> and <a href="index.html#write"><span>writing</span></a> to memory</li></ul></aside><div class="spec module" id="module-Value"><a href="#module-Value" class="anchor"></a><code><span class="keyword">module</span> Value = <a href="../../Exp/index.html#module-Value">Exp.Value</a></code></div><div class="spec module" id="module-ConcreteEval"><a href="#module-ConcreteEval" class="anchor"></a><code><span class="keyword">module</span> ConcreteEval = <a href="../../Exp/index.html#module-ConcreteEval">Exp.ConcreteEval</a></code></div><div class="spec module" id="module-Typed"><a href="#module-Typed" class="anchor"></a><code><span class="keyword">module</span> Typed = <a href="../../Exp/index.html#module-Typed">Exp.Typed</a></code></div><div class="spec module" id="module-Fragment"><a href="#module-Fragment" class="anchor"></a><code><span class="keyword">module</span> Fragment = <a href="../../State/index.html#module-Fragment">State.Fragment</a></code></div><section><header><h2 id="exp"><a href="#exp" class="anchor"></a>Expressions</h2><p>This section implements all the C type expression inference rules.</p><p>C Types are always optional and if any part of an expression is not typed, then the result is not typed.</p></header><dl><dt class="spec type" id="type-tval"><a href="#type-tval" class="anchor"></a><code><span class="keyword">type</span> tval</code><code> = </code><code>{</code><table class="record"><tr id="type-tval.ctyp" class="anchored"><td class="def field"><a href="#type-tval.ctyp" class="anchor"></a><code>ctyp : <span><a href="../../Ctype/index.html#type-t">Ctype.t</a> option</span>;</code></td></tr><tr id="type-tval.exp" class="anchored"><td class="def field"><a href="#type-tval.exp" class="anchor"></a><code>exp : <a href="../../Trace/Base/index.html#type-exp">Trace.Base.exp</a>;</code></td></tr></table><code>}</code></dt><dd><p>A typed <a href="../Base/index.html#type-exp"><code>Base.exp</code></a></p></dd></dl><dl><dt class="spec value" id="val-get_ctypo"><a href="#val-get_ctypo" class="anchor"></a><code><span class="keyword">val</span> get_ctypo : <a href="index.html#type-tval">tval</a> <span>&#45;&gt;</span> <span><a href="../../Ctype/index.html#type-t">Ctype.t</a> option</span></code></dt><dt class="spec value" id="val-get_ctyp"><a href="#val-get_ctyp" class="anchor"></a><code><span class="keyword">val</span> get_ctyp : <a href="index.html#type-tval">tval</a> <span>&#45;&gt;</span> <a href="../../Ctype/index.html#type-t">Ctype.t</a></code></dt><dt class="spec value" id="val-machine_of_size"><a href="#val-machine_of_size" class="anchor"></a><code><span class="keyword">val</span> machine_of_size : <span>?&#8288;update:int</span> <span>&#45;&gt;</span> <a href="../../Ctype/index.html#type-t">Ctype.t</a> <span>&#45;&gt;</span> <a href="../../Ctype/index.html#type-t">Ctype.t</a></code></dt><dd><p>Output a Machine type of the same size at the original type. If <code>update</code> has a value, the size if modified by the update value.</p></dd></dl><dl><dt class="spec value" id="val-unop"><a href="#val-unop" class="anchor"></a><code><span class="keyword">val</span> unop : <a href="../../Ast/index.html#type-unop">Ast.unop</a> <span>&#45;&gt;</span> <a href="index.html#type-tval">tval</a> <span>&#45;&gt;</span> <span><a href="../../Ctype/index.html#type-t">Ctype.t</a> option</span></code></dt><dt class="spec value" id="val-constexpr_to_int"><a href="#val-constexpr_to_int" class="anchor"></a><code><span class="keyword">val</span> constexpr_to_int : <span>ctxt:<a href="../../Trace/Context/index.html#type-t">Trace.Context.t</a></span> <span>&#45;&gt;</span> <span><span>(<span class="type-var">'a</span>, <a href="../../Trace/Base/Var/index.html#type-t">Trace.Base.Var.t</a>, <a href="../../Ast/index.html#type-no">Ast.no</a>, <a href="../../Ast/index.html#type-no">Ast.no</a>)</span> <a href="../../Ast/index.html#type-exp">Ast.exp</a></span> <span>&#45;&gt;</span> int</code></dt><dt class="spec value" id="val-binop"><a href="#val-binop" class="anchor"></a><code><span class="keyword">val</span> binop : <span>ctxt:<a href="../../Trace/Context/index.html#type-t">Trace.Context.t</a></span> <span>&#45;&gt;</span> <span><a href="../../Ast/index.html#type-no">Ast.no</a> <a href="../../Ast/index.html#type-binop">Ast.binop</a></span> <span>&#45;&gt;</span> <a href="index.html#type-tval">tval</a> <span>&#45;&gt;</span> <a href="index.html#type-tval">tval</a> <span>&#45;&gt;</span> <span><a href="../../Ctype/index.html#type-t">Ctype.t</a> option</span></code></dt><dt class="spec value" id="val-manyop"><a href="#val-manyop" class="anchor"></a><code><span class="keyword">val</span> manyop : <span>ctxt:<a href="../../Trace/Context/index.html#type-t">Trace.Context.t</a></span> <span>&#45;&gt;</span> <a href="../../Ast/index.html#type-manyop">Ast.manyop</a> <span>&#45;&gt;</span> <span><a href="index.html#type-tval">tval</a> list</span> <span>&#45;&gt;</span> <span><a href="../../Ctype/index.html#type-t">Ctype.t</a> option</span></code></dt><dt class="spec value" id="val-expr"><a href="#val-expr" class="anchor"></a><code><span class="keyword">val</span> expr : <span>ctxt:<a href="../../Trace/Context/index.html#type-t">Trace.Context.t</a></span> <span>&#45;&gt;</span> <a href="../../Trace/Base/index.html#type-exp">Trace.Base.exp</a> <span>&#45;&gt;</span> <span><a href="../../Ctype/index.html#type-t">Ctype.t</a> option</span></code></dt><dd><p>Stage 1 expression typer</p></dd></dl><dl><dt class="spec value" id="val-expr_tval"><a href="#val-expr_tval" class="anchor"></a><code><span class="keyword">val</span> expr_tval : <span>ctxt:<a href="../../Trace/Context/index.html#type-t">Trace.Context.t</a></span> <span>&#45;&gt;</span> <span><span>(<span><a href="../../Ast/index.html#type-no">Ast.no</a> <a href="../../Ast/index.html#type-ty">Ast.ty</a></span>, <a href="../../Trace/Base/Exp/index.html#type-var">Trace.Base.Exp.var</a>, <a href="../../Ast/index.html#type-no">Ast.no</a>, <a href="../../Ast/index.html#type-no">Ast.no</a>)</span> <a href="../../Ast/index.html#type-exp">Ast.exp</a></span> <span>&#45;&gt;</span> <a href="index.html#type-tval">tval</a></code></dt><dd><p>Same as <a href="index.html#val-expr"><code>expr</code></a> but return the expression in a <code>Tval</code></p></dd></dl></section><section><header><h2 id="read"><a href="#read" class="anchor"></a>Memory Read</h2><p>When reading memory there are two main cases:</p><ul><li>The address has a pointer type, in which case we figure out the type of the read according to that pointer type.</li><li>The address do not have a pointer type, so we try to do an untyped read with <a href="../../State/index.html#val-read_noprov"><code>State.read_noprov</code></a> which may fail.</li></ul></header><dl><dt class="spec value" id="val-fragment_at"><a href="#val-fragment_at" class="anchor"></a><code><span class="keyword">val</span> fragment_at : <span>dwarf:<a href="../../Dw/index.html#type-t">Dw.t</a></span> <span>&#45;&gt;</span> <span>fenv:<a href="../../State__Fragment/Env/index.html#type-t">Fragment.Env.t</a></span> <span>&#45;&gt;</span> <span>size:int</span> <span>&#45;&gt;</span> <a href="../../Ctype/index.html#type-fragment">Ctype.fragment</a> <span>&#45;&gt;</span> int <span>&#45;&gt;</span> <span><a href="../../Ctype/index.html#type-t">Ctype.t</a> option</span></code></dt><dt class="spec value" id="val-ptr_deref"><a href="#val-ptr_deref" class="anchor"></a><code><span class="keyword">val</span> ptr_deref : <span>dwarf:<a href="../../Dw/index.html#type-t">Dw.t</a></span> <span>&#45;&gt;</span> <span>fenv:<a href="../../State__Fragment/Env/index.html#type-t">Fragment.Env.t</a></span> <span>&#45;&gt;</span> <span>size:int</span> <span>&#45;&gt;</span> <a href="../../Ctype/index.html#type-fragment">Ctype.fragment</a> <span>&#45;&gt;</span> <a href="../../Ctype/index.html#type-offset">Ctype.offset</a> <span>&#45;&gt;</span> <span><a href="../../Ctype/index.html#type-t">Ctype.t</a> option</span></code></dt><dt class="spec value" id="val-read"><a href="#val-read" class="anchor"></a><code><span class="keyword">val</span> read : <span>dwarf:<a href="../../Dw/index.html#type-t">Dw.t</a></span> <span>&#45;&gt;</span> <a href="../../State/index.html#type-t">State.t</a> <span>&#45;&gt;</span> <span>?&#8288;ptrtype:<a href="../../Ctype/index.html#type-t">Ctype.t</a></span> <span>&#45;&gt;</span> <span>addr:<a href="../../State/index.html#type-exp">State.exp</a></span> <span>&#45;&gt;</span> <span>size:<a href="../../AstGen__Def/Size/index.html#type-t">Ast.Size.t</a></span> <span>&#45;&gt;</span> <a href="../../State/index.html#type-tval">State.tval</a></code></dt><dd><p>Does the same as <a href="../../State/index.html#val-read"><code>State.read</code></a>, but additionally take care of reading the type from a fragment and marking the type of the read variable.</p></dd></dl></section><section><header><h2 id="write"><a href="#write" class="anchor"></a>Memory Write</h2></header><dl><dt class="spec value" id="val-fragment_write_at"><a href="#val-fragment_write_at" class="anchor"></a><code><span class="keyword">val</span> fragment_write_at : <span>dwarf:<a href="../../Dw/index.html#type-t">Dw.t</a></span> <span>&#45;&gt;</span> <span>fenv:<a href="../../State__Fragment/Env/index.html#type-t">Fragment.Env.t</a></span> <span>&#45;&gt;</span> <span>ctyp:<a href="../../Ctype/index.html#type-t">Ctype.t</a></span> <span>&#45;&gt;</span> <a href="../../Ctype/index.html#type-fragment">Ctype.fragment</a> <span>&#45;&gt;</span> int <span>&#45;&gt;</span> unit</code></dt><dt class="spec value" id="val-ptr_write"><a href="#val-ptr_write" class="anchor"></a><code><span class="keyword">val</span> ptr_write : <span>dwarf:<a href="../../Dw/index.html#type-t">Dw.t</a></span> <span>&#45;&gt;</span> <span>fenv:<a href="../../State__Fragment/Env/index.html#type-t">Fragment.Env.t</a></span> <span>&#45;&gt;</span> <span>ctyp:<a href="../../Ctype/index.html#type-t">Ctype.t</a></span> <span>&#45;&gt;</span> <a href="../../Ctype/index.html#type-fragment">Ctype.fragment</a> <span>&#45;&gt;</span> <a href="../../Ctype/index.html#type-offset">Ctype.offset</a> <span>&#45;&gt;</span> unit</code></dt><dt class="spec value" id="val-write"><a href="#val-write" class="anchor"></a><code><span class="keyword">val</span> write : <span>dwarf:<a href="../../Dw/index.html#type-t">Dw.t</a></span> <span>&#45;&gt;</span> <a href="../../State/index.html#type-t">State.t</a> <span>&#45;&gt;</span> <span>?&#8288;ptrtype:<a href="../../Ctype/index.html#type-t">Ctype.t</a></span> <span>&#45;&gt;</span> <span>addr:<a href="../../State/index.html#type-exp">State.exp</a></span> <span>&#45;&gt;</span> <span>size:<a href="../../AstGen__Def/Size/index.html#type-t">Ast.Size.t</a></span> <span>&#45;&gt;</span> <a href="../../State/index.html#type-tval">State.tval</a> <span>&#45;&gt;</span> unit</code></dt><dd><p>Does the same as <a href="../../State/index.html#val-write"><code>State.write</code></a>, but additionally take care of writing the type if the write is on a <span class="xref-unresolved" title="unresolved reference to &quot;Ctype.FreeFragment&quot;"><a href="../../Ctype/index.html"><code>Ctype</code></a>.FreeFragment</span>.</p></dd></dl></section></div></body></html>