<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Z3 (read-dwarf.Z3)</title><link rel="stylesheet" href="../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 1.5.1"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="content"><header><nav><a href="../index.html">Up</a> – <a href="../index.html">read-dwarf</a> &#x00BB; Z3</nav><h1>Module <code>Z3</code></h1><p>This module handles a Z3 server</p><p>For high level usage, call <a href="index.html#val-start"><code>start</code></a> or <a href="index.html#val-ensure_started"><code>ensure_started</code></a> then instantiate the <a href="Make/index.html"><code>Make</code></a> functor and use operation in the section about <a href="module-type-S/index.html#nocontext"><span>Context less operation</span></a>:</p><p>For a more medium level usage, you may want to manage your context manually before making requests. The best way of doing that is by using a <a href="ContextCounter/index.html"><code>ContextCounter</code></a>.</p><p>Once you are in the correct context, you can use your instantiated version of <a href="Make/index.html"><code>Make</code></a> to do operations such as: <a href="module-type-S/index.html#val-declare_var"><code>S.declare_var</code></a> or <a href="module-type-S/index.html#val-send_assert"><code>S.send_assert</code></a> to build your context, and then <a href="module-type-S/index.html#val-simplify"><code>S.simplify</code></a>, <a href="module-type-S/index.html#val-check"><code>S.check</code></a> of <a href="module-type-S/index.html#val-check_sat"><code>S.check_sat</code></a>.</p><p>For low-level details (All function in the first two section of this module should probably be reserved to those who understand the implementation)</p><p>The module keeps Z3 as a child process and communicates through pipes using <a href="../Utils/Cmd/IOServer/index.html"><code>Cmd.IOServer</code></a>.</p><p><a href="index.html#val-start"><code>start</code></a> sends the introduction in <code>intro.smt2</code> to Z3 so that it is available in any context. SMT answer are parsed from the pipe with <a href="../Utils/Files/index.html#val-input_sexp"><code>Files.input_sexp</code></a>. If the wrong number of answer is expected, the system will just deadlock.</p><nav class="toc"><ul><li><a href="#raw-server-management">Raw server management</a></li><li><a href="#request-and-answer-management">Request and answer management</a></li><li><a href="#full-startup-and-shutdown">Full startup and shutdown</a></li><li><a href="#context">Context management</a></li><li><a href="#high-level-interaction">High level interaction</a></li></ul></nav></header><section><header><h2 id="raw-server-management"><a href="#raw-server-management" class="anchor"></a>Raw server management</h2></header><dl><dt class="spec value" id="val-z3_trace"><a href="#val-z3_trace" class="anchor"></a><code><span class="keyword">val</span> z3_trace : bool</code></dt><dd><p>A boolean enabling context tracing (For better error messages)</p></dd></dl><dl><dt class="spec type" id="type-context_elem"><a href="#type-context_elem" class="anchor"></a><code><span class="keyword">type</span> context_elem</code><code> = </code><code>{</code><table class="record"><tr id="type-context_elem.name" class="anchored"><td class="def field"><a href="#type-context_elem.name" class="anchor"></a><code>name : string;</code></td></tr><tr id="type-context_elem.num" class="anchored"><td class="def field"><a href="#type-context_elem.num" class="anchor"></a><code><span class="keyword">mutable</span> num : int;</code></td></tr></table><code>}</code></dt><dd><p>An element of the context stack. It has a name and a declaration number.</p><p>The declaration number is incremented at each declaration in the context.</p></dd></dl><dl><dt class="spec type" id="type-context"><a href="#type-context" class="anchor"></a><code><span class="keyword">type</span> context</code><code> = <span><a href="index.html#type-context_elem">context_elem</a> list</span></code></dt><dd><p>The type of a SMT context stack</p></dd></dl><dl><dt class="spec value" id="val-start_context"><a href="#val-start_context" class="anchor"></a><code><span class="keyword">val</span> start_context : <a href="index.html#type-context">context</a></code></dt><dd><p>The starting context</p></dd></dl><dl><dt class="spec value" id="val-context_elem_to_string"><a href="#val-context_elem_to_string" class="anchor"></a><code><span class="keyword">val</span> context_elem_to_string : <a href="index.html#type-context_elem">context_elem</a> <span>&#45;&gt;</span> string</code></dt><dd><p>Give a string representation of a <a href="index.html#type-context_elem"><code>context_elem</code></a></p></dd></dl><dl><dt class="spec type" id="type-server"><a href="#type-server" class="anchor"></a><code><span class="keyword">type</span> server</code><code> = </code><code>{</code><table class="record"><tr id="type-server.ioserver" class="anchored"><td class="def field"><a href="#type-server.ioserver" class="anchor"></a><code>ioserver : <a href="../Utils/Cmd/IOServer/index.html#type-t">Utils.Cmd.IOServer.t</a>;</code></td></tr><tr id="type-server.config" class="anchored"><td class="def field"><a href="#type-server.config" class="anchor"></a><code>config : <a href="../Config__File/Z3/index.html#type-t">Config.File.Z3.t</a>;</code></td></tr><tr id="type-server.context" class="anchored"><td class="def field"><a href="#type-server.context" class="anchor"></a><code><span class="keyword">mutable</span> context : <a href="index.html#type-context">context</a>;</code></td></tr></table><code>}</code></dt><dd><p>The type of a Z3 server</p></dd></dl><dl><dt class="spec value" id="val-server"><a href="#val-server" class="anchor"></a><code><span class="keyword">val</span> server : <span><span><a href="index.html#type-server">server</a> option</span> Stdlib.ref</span></code></dt><dd><p>The global Z3 server</p></dd></dl><dl><dt class="spec value" id="val-get_server"><a href="#val-get_server" class="anchor"></a><code><span class="keyword">val</span> get_server : unit <span>&#45;&gt;</span> <a href="index.html#type-server">server</a></code></dt><dd><p>Assume the server is started and returns it.</p></dd></dl><dl><dt class="spec value" id="val-raw_start"><a href="#val-raw_start" class="anchor"></a><code><span class="keyword">val</span> raw_start : unit <span>&#45;&gt;</span> unit</code></dt><dd><p>Start Z3 without any checks and without sending intro or pushing</p></dd></dl><dl><dt class="spec value" id="val-raw_stop"><a href="#val-raw_stop" class="anchor"></a><code><span class="keyword">val</span> raw_stop : unit <span>&#45;&gt;</span> unit</code></dt><dd><p>Stop Z3 without asking politely</p></dd></dl><dl><dt class="spec value" id="val-get_context_string"><a href="#val-get_context_string" class="anchor"></a><code><span class="keyword">val</span> get_context_string : <a href="index.html#type-server">server</a> <span>&#45;&gt;</span> string</code></dt><dd><p>Give a string representation of the current context for error reporting</p></dd></dl><dl><dt class="spec value" id="val-incr_context"><a href="#val-incr_context" class="anchor"></a><code><span class="keyword">val</span> incr_context : <a href="index.html#type-server">server</a> <span>&#45;&gt;</span> unit</code></dt><dd><p>Increment the declaration number of the top <a href="index.html#type-context_elem"><code>context_elem</code></a>.</p></dd></dl></section><section><header><h2 id="request-and-answer-management"><a href="#request-and-answer-management" class="anchor"></a>Request and answer management</h2><p>This section handle raw and less raw direct interaction with the Z3 server.</p><p>The <code>send_*</code> function are for sending information to the server with a server handle. This avoided checking if the server is open at each declaration.</p><p>The <code>read_*</code> functions are the same the other way around.</p><p>The <a href="index.html#val-request"><code>request</code></a> and <a href="index.html#val-command"><code>command</code></a> are high level versions</p></header><dl><dt class="spec value" id="val-send_string"><a href="#val-send_string" class="anchor"></a><code><span class="keyword">val</span> send_string : <a href="index.html#type-server">server</a> <span>&#45;&gt;</span> string <span>&#45;&gt;</span> unit</code></dt><dd><p>Send a string to the server and increment the declaration number in the context</p></dd></dl><dl><dt class="spec value" id="val-send_smt"><a href="#val-send_smt" class="anchor"></a><code><span class="keyword">val</span> send_smt : <a href="index.html#type-server">server</a> <span>&#45;&gt;</span> <span>?&#8288;ppv:<span>(<span class="type-var">'a</span> <span>&#45;&gt;</span> <a href="../Utils/index.html#module-Pp">Utils.Pp</a>.document)</span></span> <span>&#45;&gt;</span> <span><span>(<span class="type-var">'b</span>, <span class="type-var">'a</span>, string, <a href="../AstGen/Def/Size/index.html#type-t">AstGen.Def.Size.t</a>)</span> <a href="../AstGen/Ott/index.html#type-smt">AstGen.Ott.smt</a></span> <span>&#45;&gt;</span> unit</code></dt><dd><p>Send a smt statement to the server and increment the declaration number in the context</p></dd></dl><dl><dt class="spec value" id="val-read_string"><a href="#val-read_string" class="anchor"></a><code><span class="keyword">val</span> read_string : <a href="index.html#type-server">server</a> <span>&#45;&gt;</span> string</code></dt><dd><p>Read a string from the server (A Z3 answer is always a valid sexp)</p></dd></dl><dl><dt class="spec value" id="val-read_smt_ans"><a href="#val-read_smt_ans" class="anchor"></a><code><span class="keyword">val</span> read_smt_ans : <a href="index.html#type-server">server</a> <span>&#45;&gt;</span> <a href="../Ast/index.html#type-rsmt_ans">Ast.rsmt_ans</a></code></dt><dd><p>Read a <code>smt_ans</code> from the server</p></dd></dl><dl><dt class="spec value" id="val-request"><a href="#val-request" class="anchor"></a><code><span class="keyword">val</span> request : <span>?&#8288;ppv:<span>(<span class="type-var">'a</span> <span>&#45;&gt;</span> <a href="../Utils/index.html#module-Pp">Utils.Pp</a>.document)</span></span> <span>&#45;&gt;</span> <span><span>(<span class="type-var">'b</span>, <span class="type-var">'a</span>, string, <a href="../AstGen/Def/Size/index.html#type-t">AstGen.Def.Size.t</a>)</span> <a href="../AstGen/Ott/index.html#type-smt">AstGen.Ott.smt</a></span> <span>&#45;&gt;</span> <a href="../Ast/index.html#type-rsmt_ans">Ast.rsmt_ans</a></code></dt><dd><p>Make a request to the server and expect an answer. Will hang if there is no answer</p></dd></dl><dl><dt class="spec value" id="val-command"><a href="#val-command" class="anchor"></a><code><span class="keyword">val</span> command : <span>?&#8288;ppv:<span>(<span class="type-var">'a</span> <span>&#45;&gt;</span> <a href="../Utils/index.html#module-Pp">Utils.Pp</a>.document)</span></span> <span>&#45;&gt;</span> <span><span>(<span class="type-var">'b</span>, <span class="type-var">'a</span>, string, <a href="../AstGen/Def/Size/index.html#type-t">AstGen.Def.Size.t</a>)</span> <a href="../AstGen/Ott/index.html#type-smt">AstGen.Ott.smt</a></span> <span>&#45;&gt;</span> unit</code></dt><dd><p>Send a command or a declaration to the server</p></dd></dl><dl><dt class="spec value" id="val-expect_version"><a href="#val-expect_version" class="anchor"></a><code><span class="keyword">val</span> expect_version : <a href="index.html#type-server">server</a> <span>&#45;&gt;</span> <a href="../Ast/index.html#type-rsmt_ans">Ast.rsmt_ans</a> <span>&#45;&gt;</span> string</code></dt><dd><p>Expect a version answer and fails if it is not the case</p></dd></dl><dl><dt class="spec value" id="val-expect_exp"><a href="#val-expect_exp" class="anchor"></a><code><span class="keyword">val</span> expect_exp : <a href="index.html#type-server">server</a> <span>&#45;&gt;</span> <a href="../Ast/index.html#type-rsmt_ans">Ast.rsmt_ans</a> <span>&#45;&gt;</span> <a href="../Ast/index.html#type-rexp">Ast.rexp</a></code></dt><dd><p>Expect an expression answer and fails if it is not the case</p></dd></dl><dl><dt class="spec value" id="val-get_version"><a href="#val-get_version" class="anchor"></a><code><span class="keyword">val</span> get_version : unit <span>&#45;&gt;</span> string</code></dt><dd><p>Get the Z3 version string</p></dd></dl><dl><dt class="spec value" id="val-is_context_sat"><a href="#val-is_context_sat" class="anchor"></a><code><span class="keyword">val</span> is_context_sat : <a href="index.html#type-server">server</a> <span>&#45;&gt;</span> <span>bool option</span></code></dt><dd><p>Check if the current context is sat</p></dd></dl></section><section><header><h2 id="full-startup-and-shutdown"><a href="#full-startup-and-shutdown" class="anchor"></a>Full startup and shutdown</h2></header><dl><dt class="spec value" id="val-stop"><a href="#val-stop" class="anchor"></a><code><span class="keyword">val</span> stop : unit <span>&#45;&gt;</span> unit</code></dt><dd><p>Stop the Z3 server properly</p></dd></dl><dl><dt class="spec value" id="val-ensure_stopped"><a href="#val-ensure_stopped" class="anchor"></a><code><span class="keyword">val</span> ensure_stopped : unit <span>&#45;&gt;</span> unit</code></dt><dd><p>Call <a href="index.html#val-stop"><code>stop</code></a> if the server wasn't stopped</p></dd></dl><dl><dt class="spec value" id="val-start"><a href="#val-start" class="anchor"></a><code><span class="keyword">val</span> start : unit <span>&#45;&gt;</span> unit</code></dt><dd><p>Start the Z3 Server and setup the intro</p></dd></dl><dl><dt class="spec value" id="val-ensure_started"><a href="#val-ensure_started" class="anchor"></a><code><span class="keyword">val</span> ensure_started : unit <span>&#45;&gt;</span> unit</code></dt><dd><p>Call <a href="index.html#val-start"><code>start</code></a> if the server wasn't started</p></dd></dl><dl><dt class="spec value" id="val-ensure_started_get"><a href="#val-ensure_started_get" class="anchor"></a><code><span class="keyword">val</span> ensure_started_get : unit <span>&#45;&gt;</span> <a href="index.html#type-server">server</a></code></dt><dd><p>Call <a href="index.html#val-start"><code>start</code></a> if the server wasn't started, then return the server</p></dd></dl><dl><dt class="spec value" id="val-reset"><a href="#val-reset" class="anchor"></a><code><span class="keyword">val</span> reset : unit <span>&#45;&gt;</span> unit</code></dt><dd><p>Reset the Z3 server, forgetting everything. Useful for resetting in a test failure context, but probably shouldn't be used in normal operations</p></dd></dl></section><section><header><h2 id="context"><a href="#context" class="anchor"></a>Context management</h2><p>Z3 contexts are managed in a stack way.</p><p>There are implemented using <code>(push)</code> and <code>(pop)</code> on the Z3 side.</p><p><a href="index.html#val-open_context"><code>open_context</code></a> can open a named context. However if it is expected to open a given context name multiple times, using <a href="ContextCounter/index.html"><code>ContextCounter</code></a> is advised.</p></header><dl><dt class="spec value" id="val-open_context"><a href="#val-open_context" class="anchor"></a><code><span class="keyword">val</span> open_context : <a href="index.html#type-server">server</a> <span>&#45;&gt;</span> string <span>&#45;&gt;</span> unit</code></dt><dd><p>Open a new context with a name.</p></dd></dl><dl><dt class="spec value" id="val-close_context"><a href="#val-close_context" class="anchor"></a><code><span class="keyword">val</span> close_context : <a href="index.html#type-server">server</a> <span>&#45;&gt;</span> unit</code></dt><dd><p>Closes current context of the server</p></dd></dl><dl><dt class="spec module" id="module-ContextCounter"><a href="#module-ContextCounter" class="anchor"></a><code><span class="keyword">module</span> <a href="ContextCounter/index.html">ContextCounter</a> : <span class="keyword">functor</span> (<a href="ContextCounter/argument-1-S/index.html">S</a> : <a href="../Utils/Logs/index.html#module-type-String">Utils.Logs.String</a>) <span>&#45;&gt;</span> <span class="keyword">sig</span> ... <span class="keyword">end</span></code></dt><dd><p>Module for handling a context numbering scheme automatically.</p></dd></dl></section><section><header><h2 id="high-level-interaction"><a href="#high-level-interaction" class="anchor"></a>High level interaction</h2><p>This section provide functor that can be instantiated to get easy to use SMT functionality</p></header><dl><dt class="spec module-type" id="module-type-Var"><a href="#module-type-Var" class="anchor"></a><code><span class="keyword">module</span> <span class="keyword">type</span> <a href="module-type-Var/index.html">Var</a> = <span class="keyword">sig</span> ... <span class="keyword">end</span></code></dt><dd><p>The functors in this section require a bit more support from variable than plain <a href="../Exp/module-type-Var/index.html"><code>Exp.Var</code></a></p></dd></dl><div class="spec module-type" id="module-type-S"><a href="#module-type-S" class="anchor"></a><code><span class="keyword">module</span> <span class="keyword">type</span> <a href="module-type-S/index.html">S</a> = <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div><div class="spec module" id="module-SimpContext"><a href="#module-SimpContext" class="anchor"></a><code><span class="keyword">module</span> <a href="SimpContext/index.html">SimpContext</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div><div class="spec module" id="module-CheckContext"><a href="#module-CheckContext" class="anchor"></a><code><span class="keyword">module</span> <a href="CheckContext/index.html">CheckContext</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div><div class="spec module" id="module-Make"><a href="#module-Make" class="anchor"></a><code><span class="keyword">module</span> <a href="Make/index.html">Make</a> : <span class="keyword">functor</span> (<a href="Make/argument-1-Var/index.html">Var</a> : <a href="index.html#module-type-Var">Var</a>) <span>&#45;&gt;</span> <a href="index.html#module-type-S">S</a> <span class="keyword">with</span> <span class="keyword">type</span> <a href="Make/index.html#type-var">var</a> = <a href="Make/argument-1-Var/index.html#type-t">Var.t</a></code></div></section></div></body></html>